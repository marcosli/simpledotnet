<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Build">
  <PropertyGroup>
    <BuildCore>bin</BuildCore>
    <SourceCore>src</SourceCore>
    <Package>pkg</Package>
    <LogFile>build.log</LogFile>
    <SourceBase>src-base</SourceBase>
    <SourceBaseLib>$(SourceBase)\lib</SourceBaseLib>
    <ProductVersion>2.0</ProductVersion>
  </PropertyGroup>

  <ItemGroup>
    <SolutionFile Include="src\Simple.sln" />
  </ItemGroup>

  <Import Project="util\msbuild\MSBuild.Community.Tasks.Targets"/>

  <Target Name="Clean">
    <CreateItem></CreateItem>
    <MSBuild Projects="@(SolutionFile)" Targets="Clean"/>
    <RemoveDir Directories="$(BuildCore)" ContinueOnError="true"/>
    <RemoveDir Directories="$(Package)" ContinueOnError="true"/>
    <Delete Files="$(LogFile)"></Delete>
  </Target>

  <Target Name="GenerateTag">
    <Time Format="yMM.dhh">
      <Output TaskParameter="FormattedTime" PropertyName="BuildTag" />
    </Time>

    <Message Text="Build tag: $(BuildTag)"/>
  </Target>

  <Target Name="GenerateAssemblyInfo" DependsOnTargets="GenerateTag">
    <AssemblyInfo CodeLanguage="CS"
               OutputFile="$(SourceCore)\GlobalInfo.cs"
               AssemblyCompany="Living Consultoria"
               AssemblyProduct="Simple.Net"
               AssemblyCopyright="Copyright (c) Living Consultoria 2009"
               AssemblyTrademark=""
               ComVisible="false"
               CLSCompliant="false"
               AssemblyVersion="$(ProductVersion).$(BuildTag)"
               AssemblyFileVersion="$(ProductVersion).$(BuildTag)" />
  </Target>

  <Target Name="Build" DependsOnTargets ="GenerateAssemblyInfo">
    <MSBuild Projects="@(SolutionFile)"/>
  </Target>
  
  <Target Name="Rebuild">
    <CallTarget Targets="Clean; Build"></CallTarget>
  </Target>

  <Target Name="Test" DependsOnTargets="Build">
    <Nunit Assemblies="$(BuildCore)\SimpleTests.exe" ToolPath="util\nunit"/>
  </Target>

  <Target Name="Merge" DependsOnTargets="Build">
    <ItemGroup>
      <MergeItems Include="$(BuildCore)\SimpleCore.dll"/>
      <MergeItems Include="$(BuildCore)\SimpleLib.dll"/>
      <MergeItems Include="$(BuildCore)\SimpleServer.dll"/>
      <MergeItems Include="$(BuildCore)\Castle.Core.dll"/>
      <MergeItems Include="$(BuildCore)\Castle.DynamicProxy2.dll"/>
      <MergeItems Include="$(BuildCore)\Antlr3.Runtime.dll"/>
      <MergeItems Include="$(BuildCore)\NHibernate.Validator.dll"/>
      <MergeItems Include="$(BuildCore)\NHibernate.Validator.Specific.dll"/>
      <MergeItems Include="$(BuildCore)\NHibernate.ByteCode.Castle.dll"/>
      <MergeItems Include="$(BuildCore)\FluentNHibernate.dll"/>
      <MergeItems Include="$(BuildCore)\Iesi.Collections.dll"/>
      <MergeItems Include="$(BuildCore)\log4net.dll"/>
      <MergeItems Include="$(BuildCore)\NHibernate.dll"/>
      <MergeItems Include="$(BuildCore)\NHibernate.Linq.dll"/>
    </ItemGroup>
    
    <MakeDir Directories="$(Package)"></MakeDir>
    <ILMerge OutputFile="$(Package)\Simple.dll"
             InputAssemblies="@(MergeItems)"
             ToolPath="util\ilmerge"
             Logfile="$(LogFile)"/>
  </Target>

  <Target Name="Package" DependsOnTargets="GenerateTag;Rebuild;Test;Merge">
    <Copy SourceFiles="$(Package)\Simple.dll" DestinationFolder="$(SourceBaseLib)"/>
    <Exec Command="util\nsis\makensis src-base\Extractor.nsi &quot;/XOutFile ..\$(Package)\Simple.exe&quot;"/>
  </Target>
  
</Project>