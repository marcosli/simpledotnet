<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Build">
  <PropertyGroup>
    <GCProjectName>simpledotnet</GCProjectName>

    <LibDir>lib\</LibDir>
    <NHLibDir>$(LibDir)\Nhibernate</NHLibDir>
    
    <BuildDir>build\</BuildDir>
    <BuildBase>..\..\</BuildBase>
    <BuildDir2>$(BuildBase)$(BuildDir)</BuildDir2>

    <SourceDir>src\</SourceDir>
    <SourceBaseDir>src-tools\base\</SourceBaseDir>
    <SourceBaseLibDir>$(SourceBaseDir)\lib\</SourceBaseLibDir>

    <KeyFilePath>$(SourceDir)\Simple.snk</KeyFilePath>

    <PackageDir>pkg\</PackageDir>
    <LibraryPackageDir>$(PackageDir)\library\</LibraryPackageDir>
    <PackageDir2>$(BuildBase)$(PackageDir)</PackageDir2>

    <Configuration>Release</Configuration>
    <Platform>Any CPU</Platform>

    <ProductVersion>2.0</ProductVersion>

    <TestAssembly>$(BuildDir)\Simple.Tests.exe</TestAssembly>
  </PropertyGroup>

  <ItemGroup>
    <SolutionFile Include="$(SourceDir)\Simple.sln" />
  </ItemGroup>

  <Import Project="util\msbuild\MSBuild.Community.Tasks.Targets"/>
  <Import Project="util\msbuild\Simple.Tools.MsBuild.Targets"/>

  <Target Name="Clean">
    <MSBuild Projects="@(SolutionFile)" Targets="Clean" Properties="Configuration=$(Configuration);Platform=$(Platform);OutDir=$(BuildDir2)"/>
    <RemoveDir Directories="$(BuildDir)" ContinueOnError="true"/>
    <RemoveDir Directories="$(LibraryPackageDir)" ContinueOnError="true"/>
    <RemoveDir Directories="$(PackageDir)" ContinueOnError="true"/>
  </Target>

  <Target Name="GenerateTag">
    <Time Format="yMM.dhh">
      <Output TaskParameter="FormattedTime" PropertyName="BuildTag" />
    </Time>

    <Message Text="Build tag: $(BuildTag)"/>
  </Target>

  <Target Name="GenerateAssemblyInfo" DependsOnTargets="GenerateTag">
    <AssemblyInfo CodeLanguage="CS"
               OutputFile="$(SourceDir)\GlobalInfo.cs"
               AssemblyCompany="Living Consultoria"
               AssemblyProduct="Simple.Net"
               AssemblyCopyright="Copyright (c) Living Consultoria 2009"
               AssemblyTrademark=""
               ComVisible="false"
               CLSCompliant="false"
               AssemblyVersion="$(ProductVersion).$(BuildTag)"
               AssemblyFileVersion="$(ProductVersion).$(BuildTag)" />
  </Target>

  <Target Name="Build" DependsOnTargets ="GenerateAssemblyInfo">
    <MSBuild Projects="@(SolutionFile)" Properties="Configuration=$(Configuration);Platform=$(Platform);OutDir=$(BuildDir2)"/>
  </Target>

  <Target Name="Rebuild">
    <CallTarget Targets="Clean; Build"></CallTarget>
  </Target>

  <Target Name="Test" DependsOnTargets="Build">
    <Nunit Assemblies="$(TestAssembly)" ToolPath="util\nunit"/>
  </Target>

  <Target Name="MergeNH">
    <ItemGroup>
      <NHibernateItems Include="$(NHLibDir)\NHibernate.dll"/>
      <NHibernateItems Include="$(NHLibDir)\Castle.Core.dll"/>
      <NHibernateItems Include="$(NHLibDir)\Castle.DynamicProxy2.dll"/>
      <NHibernateItems Include="$(NHLibDir)\Antlr3.Runtime.dll"/>
      <NHibernateItems Include="$(NHLibDir)\NHibernate.Validator.dll"/>
      <NHibernateItems Include="$(NHLibDir)\NHibernate.Validator.Specific.dll"/>
      <NHibernateItems Include="$(NHLibDir)\NHibernate.ByteCode.Castle.dll"/>
      <NHibernateItems Include="$(NHLibDir)\FluentNHibernate.dll"/>
      <NHibernateItems Include="$(NHLibDir)\Iesi.Collections.dll"/>
      <NHibernateItems Include="$(NHLibDir)\Remotion.Data.Linq.dll"/>
    </ItemGroup>
    <ILMerge OutputFile="$(LibDir)\Simple.NHibernate.dll"
            InputAssemblies="@(NHibernateItems)"
            ToolPath="util\ilmerge"
            LogFile=""
            KeyFile="$(KeyFilePath)"
             />
  </Target>
  
  <Target Name="CopyToPackageFolder" DependsOnTargets="Build">
    <ItemGroup>
      <MergeItems Include="$(BuildDir)\Simple.Data.dll"/>
      <MergeItems Include="$(BuildDir)\Simple.NHibernate.dll"/>

      <OtherItems Include="$(BuildDir)\Simple.dll"/>
      <OtherItems Include="$(BuildDir)\log4net.dll"/>
    </ItemGroup>

    <MakeDir Directories="$(PackageDir)"></MakeDir>
    <MakeDir Directories="$(LibraryPackageDir)"></MakeDir>

    <ILMerge OutputFile="$(LibraryPackageDir)\Simple.Data.dll"
             InputAssemblies="@(MergeItems)"
             ToolPath="util\ilmerge"
             LogFile=""
             KeyFile="$(KeyFilePath)" DebugInfo="false"
             />

    <Copy SourceFiles="@(OtherItems)" DestinationFolder ="$(LibraryPackageDir)"/>
  </Target>

  <Target Name="Package" DependsOnTargets="Build;CopyToPackageFolder">
    <ItemGroup>
      <LibraryFiles Include="$(LibraryPackageDir)\**" Exclude="$(LibraryPackageDir)\**\*.pdb" />
    </ItemGroup>
    
    <Copy SourceFiles="@(LibraryFiles)" DestinationFolder="$(SourceBaseLibDir)"/>
    <Exec Command="util\nsis\makensis $(SourceBaseDir)\Extractor.nsi &quot;/XOutFile $(PackageDir2)\Simple.exe&quot;"/>
    <Zip Files="@(LibraryFiles)" ZipFileName="$(PackageDir)\Simple.zip" WorkingDirectory="$(LibraryPackageDir)"/>
  </Target>

  <Target Name="Publish" DependsOnTargets="Test;Package">
    <UploadToGoogleCode
     UserName="$(GCUsername)"
     Password="$(GCPassword)"
     ProjectName="$(GCProjectName)"
     LocalFile="$(PackageDir)\Simple.zip"
     TargetFileName="Simple-Nightly.zip"
     Summary="Simple.Net Library v$(ProductVersion).$(BuildTag)"
     Labels="Nightly;Type-Package"
      />

    <UploadToGoogleCode
      UserName="$(GCUsername)"
      Password="$(GCPassword)"
      ProjectName="$(GCProjectName)"
      LocalFile="$(PackageDir)\Simple.exe"
      TargetFileName="Simple-Nightly.exe"
      Summary="Simple.Net Project Starter v$(ProductVersion).$(BuildTag)"
      Labels="Nightly;Type-Executable;Featured"
      />
  </Target>
</Project>